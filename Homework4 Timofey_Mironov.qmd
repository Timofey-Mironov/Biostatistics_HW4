---
title: "Homework#4"
author: "Timofey_Mironov"
format: html
editor: visual
---

## 

# Задание № 1

**Проводят некоторое исследование пациентов с артериальной гипертензией. Предположим, что внедрение нового препарата в среднем лучше снижает их давление по сравнению со стандартной терапией.**

**Задайте `seed` для воспроизводимости результатов (функция `set.seed()`). Задайте размер выборки `sample_size <- 30`. Задайте значение среднего артериального давления до приема нового препарата и после.**

**Затем:**

-   **Сформулируйте нулевую и альтернативную гипотезы.**

-   **Определите уровень значимости.**

-   **Выберите статистический тест для проверки гипотезы и аргументируйте свой выбор.**

-   **Определите наблюдаемое значение статистики, а также критическое значение статистики.**

-   **Оцените и прокомментируйте статистическую значимость.**

```{r}
# Импорты
library(tidyverse)
library(car)
library(ggplot2)
```

```{r}
# Фиксируем вводные
set.seed(15)
sample_size <- 30
# Cредние Цифры АД до/после применения нового препарата
AD_before = 155
AD_after = 125

```

```{r}
# Генерируем распределения
pressure_before <- rnorm(sample_size, AD_before, 10)
pressure_after <- rnorm(sample_size, AD_after, 8)
pressure_df <- data.frame(
  "Pressure_before" = pressure_before,
  "Pressure_after" = pressure_after
)
pressure_df
```

```{r}
# Чтобы определиться с выбором теста - > оценим распределение визуально
# Гистограмма распределения до приёма нового препарата
ggplot(pressure_df, aes(x = pressure_before)) + 
  geom_histogram(binwidth = 3, fill = 'purple', color = 'black') +
  labs(title = 'Гистограмма распределения АД до приёма нового препарата')
```

#### Распределение напоминает нормальное -\> форма напоминает колокол, хоть и не идеальный, среднее значение соответствует его вершине.

```{r}
# Распределение после приёма нового препарата
ggplot(pressure_df, aes(pressure_after)) + 
  geom_histogram(binwidth = 5, fill = 'orange', color = 'black') + 
  labs(title = 'Гистограмма распределения после введения нового препарата')
```

#### Этот график уже гораздо меьнше напоминает нормальное распределение

```{r}
# Удостоверимся в нормальности посредством теста Шапиро
# Формулируем гипотезы
#H_0 = 'Данные имеют нормальное распределение'
#H_1 = 'Данные не имеют нормального распределения'

# alpha = 0.05

print(shapiro.test(pressure_df$Pressure_before))
print(shapiro.test(pressure_df$Pressure_after))

```

### В обоих случаях p_value \> P_value -\> Не может Отвергнуть нулевую гипотезу - \> Принимаем её -\> Распределение нормальное

```{r}
# Поскольку данные распределены нормально, переменная для анализа количественная, выборки зависимые -> Применяем парный t_test
mean(pressure_df$Pressure_before)
mean(pressure_df$Pressure_after)
t.test(pressure_df$Pressure_before, pressure_df$Pressure_after, paired = TRUE)
```

```{r}
# Расчитываем критического значения
alpha = 0.05
qt(1 - alpha / 2, df = 29) # Степени свободы = 29(30-1)
```

```         
p-value = 7.955e-15
```

#### H0 = Уровень АД Статистически значимо не отличается до и после приёма нового препарата

#### H1 = Уровень АД статистически значимо отличается до и после приёма нового препарата

### P_value \< alpha -\> отвергаем нулевую гипотезу

**Итог: Имеется статистически значимая разница между уровнем АД до и после приёма препарата. Таким образом препарат зарекомендовал себя как хорошее антигипертензивное средство.**

## Задание 2 (2 балла)

**Рассмотрите следующую статистическую гипотезу.**

**Существует некоторая связь между курением и развитием рака легких. Пусть у курящих людей вероятность заболеть раком легких составляет 0.8, а у некурящих — 0.2**

Рассмотрите два случая: для выборки `sample_size1 <- 100` и выборки `sample_size2 <- 30`. Сгенерируйте данные по курению с помощью функции `rep()`, пусть отношение числа курящих к некурящим в каждой выборке составляет 1:1.

**Затем:**

-   Сформулируйте нулевую и альтернативную гипотезы.

-   Определите уровень значимости.

-   Выберите статистический тест для проверки гипотезы и аргументируйте свой выбор.

-   Определите наблюдаемое значение статистики, а также критическое значение статистики.

-   Оцените и прокомментируйте статистическую значимость.

```{r}
sample_size1 <- 100

# Создаём вектор курящих -> 1, вектор некурящих -> 0
smoke_vector <- rep(c(1, 0), each = (sample_size1 / 2))

# Генерируем данные
set.seed(15) 
cancer_and_smoke <- rbinom((sample_size1 / 2), 1, 0.8)
cancer_and_nosmoke <- rbinom((sample_size1 / 2), 1, 0.2)
# Объединяем
full_cancer <- c(cancer_and_smoke, cancer_and_nosmoke)

smoke_df <- data.frame(
  "smoking" = smoke_vector,
  "lung_cancer" = full_cancer
)
head(smoke_df)
```

```{r}
# То же самое для второй выборки
sample_size2 <- 30

# Создаём вектор курящих -> 1, вектор некурящих -> 0
smoke_vector_2 <- rep(c(1, 0), each = (sample_size2 / 2))

# Генерируем данные
set.seed(7) 
cancer_and_smoke <- rbinom((sample_size2 / 2), 1, 0.8)
cancer_and_nosmoke <- rbinom((sample_size2 / 2), 1, 0.2)
# Объединяем
full_cancer_2 <- c(cancer_and_smoke, cancer_and_nosmoke)

smoke_df_2 <- data.frame(
  "smoking" = smoke_vector_2,
  "lung_cancer" = full_cancer_2
)
head(smoke_df_2)
```

`H0 (нулевая гипотеза) - вероятность развития рака легких одинакова как у курящих, так и у некурящих`

`H1 (альтернативная гипотеза) - в группе курящих вероятность развития рака лёгких выше, чем у некурящих.`

**Уровень значимости: alpha = 0.05**

```{r}
# График для первой выборки
barplot(table(smoke_df$smoking, smoke_df$lung_cancer), beside = TRUE,
        col = c("green", "red"), legend = c("Нет рака легких", "Рак легких"),
        names.arg = c('Курящие', 'Некурящие'))
        
```

```{r}
# График для второй
barplot(table(smoke_df_2$smoking, smoke_df_2$lung_cancer), beside = TRUE,
        col = c("green", "red"), legend = c("Нет рака легких", "Рак легких"),
        names.arg = c('Курящие', 'Некурящие'))
```

```{r}
# рак легких распределен неравномерное
# наши переменные категориальные
# Выборки независимые
# Во второй выборке неожиданность -> Рак легких у некурящих встречается значительно чаще. 

# В данном случае лучше всего подойдёт критерий Фишера

```

```{r}
# Тест фишера на выборке из 100 наблюдений
# таблица сопряженности
contingency_table100 <- table(smoke_df$smoking, smoke_df$lung_cancer)

# Непосредственно тест Фишера
fisher_test_result100 <- fisher.test(contingency_table100, alternative = 'greater')

fisher_test_result100
```

```{r}
# Такой же тест проводим для выборки из 30 наблюдений
contingency_table30 <- table(smoke_df_2$smoking, smoke_df_2$lung_cancer)

fisher_test_result30 <- fisher.test(contingency_table30, alternative = 'greater')
fisher_test_result30
```

**В обоих случаях p_value \< 0.05** -\> Отвергаем нулевую гипотезу.

**Итог:** В группе курящих риск развития рака лёгких значительно выше, чем в группе некурящих

Odd ratio показывает, что для курящих шанс развития рака выше в 6 раз в выборке из 100 и в 11.7 раз для выборки из 30 соответственно.

# Задание № 3

**Рассмотрите следующую статистическую гипотезу.**

**Применение нового метода лечения синдрома раздраженного кишечника значимо меняет уровень болевых симптомов по сравнению с группой, прошедшей лечение диетотерапией.**

**Исследователь избегает любых допущений, кроме того, что выборки независимы и имеют одинаковое распределение.**

**Что нужно сделать:**

-   Сформулируйте нулевую и альтернативную гипотезы.

-   Определите уровень значимости.

-   Выберите статистический тест для проверки гипотезы и аргументируйте свой выбор.

-   Определите наблюдаемое значение статистики, а также критическое значение статистики.

-   Оцените и прокомментируйте статистическую значимость.

```{r}
set.seed(40)
sample_size_task3 <- 50

# Отклонения в группах
# группа с новой методикой
mean_new_method <- 5
sd_new_method <- 2
# Группа с диетотерапией
mean_diet_group <- 6
sd_diet_group <- 3
```

```{r}
# Герерируем выборки c нормальным распределением
new_method_group <- round(
  rnorm(sample_size_task3, mean_new_method, sd_new_method)
)

diet_method_group <- round(
  rnorm(sample_size_task3, mean_diet_group, sd_diet_group)
)

# Комбинируем группы в датасет
task3_df <- data.frame(
  "new_method" = new_method_group,
  "diet_method" = diet_method_group
)

head(task3_df)
```

#### Формулируем гипотезы:

**H0: статистически значимая разница между эффективностью лечения болевого при СРК новым методом и диетотерапией отсутствует.**

**H1: Имеется статистически значимая разница между эфективностью лечения болевого синдрома при СРК новым методом и диетотерапией.**

**Уровень значимости = 0.05**

```{r}
# Визуально оценим данные на нормальность
# Визуализируем распределение группы, использующей новый метод лечения
ggplot(task3_df, aes(x=new_method)) +
  geom_histogram(binwidth = 1, fill='white', color='black') +
  labs(title = 'Гистограмма распределения уровня боли при испольовании нового метода лечения', x='уровень боли', y='частота')
```

Напоминает нормально распределение

```{r}
# Группа, использующая диетотерапию
ggplot(task3_df, aes(x=diet_method)) +
  geom_histogram(binwidth = 3, fill='lightblue', color='black', linetype="dashed") +
  labs(title = 'Гистограмма распределения уровня боли при использовании диетотерапии', x='уровень боли', y='частота')
  
```

**Это распределение уже точно не является нормальным**

```{r}
# Проводим тест шапиро на нормальность
shapiro.test(task3_df$new_method)
shapiro.test(task3_df$diet_method)
```

В первой выборке **p_value \> 0.05 -\>** Распределение нормальное

Во второй выборке **p_value \< 0.05 -\>** Распределение отличное от нормального.

```{r}
# Одна из двух выборок не имеет нормального распределения
# Уровень боли -> дискретная переменная
# Выборки независимы друг от друга

# Исходя из вышеперечисленных пунктов, t-test нам не подходит, поэтому воспользуемся его непараметрическим аналогом -> Двусторонним тестом Манна-Уитни

wilcox.test(task3_df$new_method, task3_df$diet_method)

# Средние значения 
mean(task3_df$new_method)
mean(task3_df$diet_method)
```

n1 = n2 = 50 -\> По таблицам определяем, что критическое значение = 1010

Значение статистики W = 765. Значительно меньше критического.

**Итоги:**

1.  p_value \< alpha -\> Отвергаем нулевую гипотезу, т.е. имеются статистически значимые различия между эффективностью лечения новым методом и диетотерапией.
2.  Исходя из средних значений - \> в группе new_method среднее значение боли ниже чем в группе diet_method -\> болевой синдром эффективнее купируется именно посредством новой методики лечения.

## 

# Задание № 4

**Рассмотрите следующую гипотезу.**

Проводится исследование, в котором исследуются три противоопухолевые препарата A, B плацебо (0) на трех группах мышей. В каждой из трех групп по 10 мышей.  Оценивается размер опухоли у мыши.

**Сгенерируйте датасет следующим образом:**

```         
tumor <- tibble(   therapy = c(rep("0", 10), rep("A", 10), rep("B", 10)),   value = c(rep(3213, 10), rep(2687, 10), rep(2423, 10)) ) %>%   mutate(therapy = factor(therapy, levels = c("0", "A", "B"))) tumor$value <- tumor$value + rnorm(30, 0, 760)
```

**Постройте на одном графике три «ящика с усами» для наглядности.**

-   Проведите дисперсионный анализ, чтобы выяснить, есть ли разница между размером опухоли во всех группах. 

-   Прокомментируйте получившийся результат.

-   С помощью функции `TukeyHSD()` проведите попарные сравнения, используя критерий Тьюки.

-   Прокомментируйте полученные результаты.

```{r}
# Генерируем датасет в соответствии с инструкцией
tumor <- tibble(
  therapy = c(rep("0", 10), rep("A", 10), rep("B", 10)),
  value = c(rep(3213, 10), rep(2687, 10), rep(2423, 10))
) %>%
  mutate(therapy = factor(therapy, levels = c("0", "A", "B")))

tumor$value <- tumor$value + rnorm(30, 0, 760)
```

```{r}
# Строим 3 боксплота
ggplot(tumor, aes(x = therapy, y = value, fill = therapy)) +
  geom_boxplot(col = 'green') +
  labs(title = 'Распределение среднего размера опухоли', x = 'метод лечения', y = 'Размер опухоли')
```

#### На графике видно, что средний размер опухоли  угруппы плацебо значительно выше, самые маленькие размеры в группе В

```{r}
# для дисперсионного анализа нужно убедиться, что данные во всхе группах распределены нормально, а также соблюдено равенство дисперсий(требование гомоскедастичности)

tumor %>% 
  ggplot(aes(value, fill = therapy)) + 
  geom_density(alpha = 0.7) + 
  labs(title = 'График распределения размера опухоли в зависимости от метода лечения', x = 'Размер опузоли', y = 'Распределение') + theme_update()
```

Нормальное распределение визуально лишь в группе **A**

```{r}
# Тест шапиро на нормальность
shapiro.test(tumor$value[tumor$therapy == 0])
shapiro.test(tumor$value[tumor$therapy == 'A'])
shapiro.test(tumor$value[tumor$therapy == 'B'])
```

p_value:

1.  0.677 - Для плацебо
2.  0.02433 - для выборки А
3.  0.5381 - для выборки В

Для плацебо и выборки В мы не может отвергуть нулевую гипотезу -\> данные распределены нормально

Для выборки А мы отвергаем нуелвую гипотезу -\> данные в этой выбокре распределены ненормально.

```{r}
# Теперь проверяем на гомогенность дисперсий
# H_0 -> дисперсии гомогенны
# H_1 -> дисперсии негомогенны

leveneTest(value ~ therapy, data=tumor)
```

p_value \< alpha(0.05) -\> Дисперсии во всхе трёх выборгам гомогенны

Поскольку не во всех группах распредление нормальное -\> ANNOVA не подходит. Выбираем тест Краскела-Уоллиса - непараметрчиеский аналог ANNOVA.

```{r}
kruskal.test(value~therapy, data=tumor)
```

Chi-квадрат = 15.894

Количество степеней свободы - 2

**p_value \< alpha -\>** отвергаем нулевую гипотезу.

Итог: Есть статистически значимые различия между размером опухоли в 3 выборках.

```{r}
# Посколькоу тест Тьюки является следующем этапом после ANNOVA -> Мы вынужденые провести дисперсионный анализ и таким образом. 
ANNOVA <- aov(value~therapy, data=tumor)
summary(ANNOVA)
```

### Итоги:

1.  p_vlaue = 0.000232
2.  Сумма квадратов = 12329307
3.  Среднее квадратичное отклонение при межгрупповом сравнении = 616653
4.  F-статистика = 11.59

Так как P_value вновь больше alpha -\> не можем принять H0 -\> принимаем H1.

Имеются статистически значимые различия между размером опухоли в трёх группах.

```{r}
# тесть Тьюки
TukeyHSD(ANNOVA, conf.level = 0.95)
```

### Итоги:

**p_adj** = p_value для множественного сравнения

1.  при сравнении А-0 и В-0 -\> p_adj \< alpha. Мы принимаем альтернативную гипотезу -\> в этих группах есть статистически значимая разница.
2.  при сравнении В-А - \> p_adj \> alpha - статистически значимая разница отсутствует.

**В результате сравнения размеров опухоли у мышей в 3 разных группах лечения мы видим, что между группами A и В нет статистически значимой разницы. Группа плацебо (0) имеет рпазличия при сравнении с остальными.**
